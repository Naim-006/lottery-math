<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Group Lottery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .nav-tabs .nav-link {
            font-weight: 500;
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        .group-card {
            border: none;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
            height: 100%;
        }
        
        .group-card:hover {
            transform: translateY(-5px);
        }
        
        .group-card .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
        }
        
        .student-item {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .student-item:last-child {
            border-bottom: none;
        }
        
        .badge-count {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-full {
            background-color: var(--danger-color);
            color: white;
        }
        
        #resultAnimation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.85));
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .lottery-wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 2rem auto;
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .lottery-wheel {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 2s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            transform-origin: center center;
        }
        
        .wheel-outer-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(67, 97, 238, 0.5),
                       inset 0 0 30px rgba(67, 97, 238, 0.3);
            animation: glow 2s ease-in-out infinite;
        }
        
        .wheel-inner-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border-radius: 50%;
            border: 4px solid var(--secondary-color);
            box-shadow: 0 0 20px rgba(63, 55, 201, 0.4);
        }
        
        .wheel-segment {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center center;
            clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%);
        }
        
        .wheel-segment-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            opacity: 0.9;
            transition: all 0.3s ease;
            transform-origin: center center;
        }
        
        .wheel-segment-inner:hover {
            opacity: 1;
            filter: brightness(1.2);
        }
        
        .wheel-number {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at center, var(--success-color), var(--secondary-color));
            border-radius: 50%;
            z-index: 3;
            box-shadow: 0 0 40px var(--success-color);
            border: 4px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid var(--danger-color);
            z-index: 4;
            filter: drop-shadow(0 0 15px var(--danger-color));
        }
        
        .wheel-pointer::after {
            content: '';
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: var(--danger-color);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--danger-color);
        }
        
        .result-display {
            text-align: center;
            margin-top: 2rem;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease-out forwards;
        }
        
        .result-number {
            font-size: 6rem;
            font-weight: bold;
            color: var(--success-color);
            text-shadow: 0 0 30px var(--success-color);
            margin: 1rem 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 1rem 2rem;
            border-radius: 20px;
            border: 3px solid var(--success-color);
            display: inline-block;
            backdrop-filter: blur(5px);
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 30px rgba(67, 97, 238, 0.5); }
            50% { box-shadow: 0 0 50px rgba(67, 97, 238, 0.8); }
            100% { box-shadow: 0 0 30px rgba(67, 97, 238, 0.5); }
        }
        
        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background-color: var(--success-color);
            opacity: 0;
            z-index: 1001;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        
        @keyframes confetti-fall {
            0% { 
                transform: translateY(-100vh) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translateY(100vh) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }
        
        .admin-panel {
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(67, 97, 238, 0.1);
        }
        
        .group-management {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        
        .group-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .group-name-edit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .group-name-edit input {
            font-weight: bold;
            border: 2px solid transparent;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .group-name-edit input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .add-member-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><i class="bi bi-people-fill"></i> Class Group Lottery</h1>
            <p class="text-muted">Randomly assign students to groups with persistent storage</p>
        </div>
        
        <ul class="nav nav-tabs" id="appTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">
                    <i class="bi bi-person-fill"></i> Student View
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">
                    <i class="bi bi-gear-fill"></i> Admin Panel
                </button>
            </li>
        </ul>
        
        <div class="tab-content py-4" id="appTabContent">
            <!-- Student View -->
            <div class="tab-pane fade show active" id="student" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="card shadow-sm mb-5">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-person-plus-fill"></i> Join Your Group</h5>
                            </div>
                            <div class="card-body">
                                <form id="joinGroupForm">
                                    <div class="mb-3">
                                        <label for="studentName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="studentName" placeholder="Enter your full name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="studentId" class="form-label">Student ID</label>
                                        <input type="text" class="form-control" id="studentId" placeholder="Enter your student ID" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="studentGroup" class="form-label">Select Your Group</label>
                                        <select class="form-select" id="studentGroup" required>
                                            <option value="">Choose your group...</option>
                                        </select>
                                        <small class="text-muted">Groups show current member count and capacity</small>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 py-2">
                                        <i class="bi bi-check-circle-fill"></i> Join Group
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4 class="text-center mb-4"><i class="bi bi-collection-fill"></i> Current Groups</h4>
                <div class="row" id="groupsContainer">
                    <!-- Groups will be loaded here -->
                </div>
            </div>
            
            <!-- Admin View -->
            <div class="tab-pane fade" id="admin" role="tabpanel">
                <div id="adminLogin" class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-shield-lock-fill"></i> Admin Authentication</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="adminPasskey" class="form-label">Admin Passkey</label>
                            <input type="password" class="form-control" id="adminPasskey" placeholder="Enter admin passkey">
                        </div>
                        <button class="btn btn-primary w-100" id="loginBtn">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </button>
                        <div class="alert alert-danger mt-3 d-none" id="loginError">
                            Invalid passkey. Please try again.
                        </div>
                    </div>
                </div>
                
                <div id="adminPanel" class="d-none">
                    <div class="admin-panel">
                        <h5 class="mb-3"><i class="bi bi-sliders"></i> Group Configuration</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="groupCount" class="form-label">Number of Groups</label>
                                <select class="form-select" id="groupCount" ${isLocked ? '' : 'disabled'}>
                                    <option value="5">5 Groups (10 students each)</option>
                                    <option value="10">10 Groups (5 students each)</option>
                                    <option value="custom">Custom Setup</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 d-none" id="customGroupContainer">
                                <label for="customGroupCount" class="form-label">Custom Number of Groups</label>
                                <input type="number" class="form-control" id="customGroupCount" min="2" max="20" value="5" ${isLocked ? '' : 'disabled'}>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" id="lockGroups">
                                    <i class="bi bi-lock-fill"></i> ${isLocked ? 'Unlock Groups' : 'Lock Groups'}
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" id="unlockGroups" ${!isLocked ? 'disabled' : ''}>
                                    <i class="bi bi-unlock-fill"></i> Unlock Groups
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" id="resetBtn">
                                    <i class="bi bi-trash-fill"></i> Reset All Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3" id="adminStatus">
                            <i class="bi bi-info-circle-fill"></i> Loading group status...
                        </div>
                    </div>
                    
                    <div class="admin-panel mt-4">
                        <!-- Add Member Button - Made more prominent -->
                        <div class="card mb-4">
                            <div class="card-body text-center">
                                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                                    <i class="bi bi-person-plus-fill"></i> Add New Member to Group
                                </button>
                                <p class="text-muted mt-2 mb-0">Click here to add a new student to any group</p>
                            </div>
                        </div>

                        <!-- Member List -->
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul"></i> Current Members List</h6>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" class="form-control form-control-sm" id="memberSearch" placeholder="Search members...">
                                    <button class="btn btn-light btn-sm" type="button" id="clearSearch">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th>ID</th>
                                                <th>Current Group</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminMemberList">
                                            <!-- Members will be listed here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="bi bi-list-check"></i> Student Registry</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>ID</th>
                                        <th>Group</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentRegistry">
                                    <!-- Students will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Edit Student Modal -->
                    <div class="modal fade" id="editStudentModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Student</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editStudentForm">
                                        <input type="hidden" id="editStudentId">
                                        <div class="mb-3">
                                            <label for="editStudentName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="editStudentName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editStudentGroup" class="form-label">Group</label>
                                            <select class="form-select" id="editStudentGroup">
                                                <option value="">Select Group</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="saveStudentEdit">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add this inside the admin panel div, after the student registry table -->
                    <div class="group-management mt-4">
                        <h5 class="mb-3"><i class="bi bi-diagram-3-fill"></i> Group Management</h5>
                        <div class="row" id="adminGroupsContainer">
                            <!-- Groups will be loaded here -->
                        </div>
                    </div>

                    <!-- Add Member Modal - Made more user-friendly -->
                    <div class="modal fade" id="addMemberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-person-plus-fill"></i> Add New Member</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addMemberForm">
                                        <div class="mb-3">
                                            <label for="newMemberName" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="newMemberName" placeholder="Enter student's full name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newMemberId" class="form-label">Student ID</label>
                                            <input type="text" class="form-control" id="newMemberId" placeholder="Enter student ID" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newMemberGroup" class="form-label">Assign to Group</label>
                                            <select class="form-select" id="newMemberGroup" required>
                                                <option value="">Select a group...</option>
                                            </select>
                                            <small class="text-muted">Groups show current member count and capacity</small>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="saveNewMember">
                                        <i class="bi bi-person-plus-fill"></i> Add Member
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Member Modal -->
                    <div class="modal fade" id="editMemberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Member</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editMemberForm">
                                        <input type="hidden" id="editMemberId">
                                        <div class="mb-3">
                                            <label for="editMemberName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="editMemberName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editMemberGroup" class="form-label">Group</label>
                                            <select class="form-select" id="editMemberGroup" required>
                                                <option value="">Select Group</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="saveMemberEdit">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap & jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main App Script -->
    <script>
        // JSONBin.io Configuration
        // To get these credentials:
        // 1. Sign up at https://jsonbin.io/
        // 2. Create a new bin (or use an existing one)
        // 3. Get your Master Key from your dashboard
        // 4. Get your Bin ID from the URL of your bin (https://jsonbin.io/b/YOUR_BIN_ID)
        const BIN_ID = '684d5dd38960c979a5a9c03e'; // Your Bin ID
        const API_KEY = '$2a$10$aakmKGvTIuJG/JpmOAAETOcqb3FEPYjeCeiQFQe/Zjj1o4Bq6O6V6'; // Your Master Key
        const ADMIN_PASSKEY = 'securePass123'; // Change this to your desired admin password
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const studentView = document.getElementById('student');
            const adminView = document.getElementById('admin');
            const adminLogin = document.getElementById('adminLogin');
            const adminPanel = document.getElementById('adminPanel');
            const loginBtn = document.getElementById('loginBtn');
            const adminPasskey = document.getElementById('adminPasskey');
            const loginError = document.getElementById('loginError');
            
            const joinGroupForm = document.getElementById('joinGroupForm');
            const studentNameInput = document.getElementById('studentName');
            const studentIdInput = document.getElementById('studentId');
            const groupsContainer = document.getElementById('groupsContainer');
            const resultAnimation = document.getElementById('resultAnimation');
            const resultText = document.getElementById('resultText');
            
            const lockGroupsBtn = document.getElementById('lockGroups');
            const groupCountSelect = document.getElementById('groupCount');
            const customGroupContainer = document.getElementById('customGroupContainer');
            const customGroupCount = document.getElementById('customGroupCount');
            const adminStatus = document.getElementById('adminStatus');
            const studentRegistry = document.getElementById('studentRegistry');
            const resetBtn = document.getElementById('resetBtn');
            
            // App State
            let groups = [];
            let students = [];
            let isLocked = false;
            let groupCount = 5;
            let groupSize = 10;
            let isAdminAuthenticated = false;
            
            // Initialize the app
            init();
            
            // Event Listeners
            loginBtn.addEventListener('click', handleAdminLogin);
            joinGroupForm.addEventListener('submit', handleJoinGroup);
            lockGroupsBtn.addEventListener('click', handleLockGroups);
            groupCountSelect.addEventListener('change', handleGroupCountChange);
            customGroupCount.addEventListener('change', updateCustomGroupCount);
            resetBtn.addEventListener('click', resetApplication);
            
            // Initialize with default data structure
            const initialData = {
                groups: Array(10).fill().map(() => []),
                students: [],
                isLocked: false,
                groupCount: 5,
                groupSize: 10,
                createdAt: new Date().toISOString()
            };
            
            // Main Functions
            async function init() {
                try {
                    const data = await fetchData();
                    
                    if (data) {
                        groups = data.groups || initialData.groups;
                        students = data.students || initialData.students;
                        isLocked = data.isLocked || initialData.isLocked;
                        groupCount = data.groupCount || initialData.groupCount;
                        groupSize = data.groupSize || initialData.groupSize;
                        
                        updateUI();
                    } else {
                        // If no data found, create initial bin
                        await createBin();
                        groups = initialData.groups;
                        students = initialData.students;
                        isLocked = initialData.isLocked;
                        groupCount = initialData.groupCount;
                        groupSize = initialData.groupSize;
                    }
                } catch (error) {
                    console.error('Initialization error:', error);
                    alert('Failed to initialize application. Please try again later.');
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: {
                            'X-Master-Key': API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            return null; // Bin doesn't exist
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    console.error('Fetch error:', error);
                    return null;
                }
            }
            
            async function createBin() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY,
                            'X-Bin-Name': 'Class Group Lottery Data'
                        },
                        body: JSON.stringify(initialData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to create bin');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Bin creation error:', error);
                    return null;
                }
            }
            
            async function saveData() {
                const data = {
                    groups,
                    students,
                    isLocked,
                    groupCount,
                    groupSize,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to save data');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Save error:', error);
                    // Fallback to localStorage
                    localStorage.setItem('lotteryData', JSON.stringify(data));
                    return null;
                }
            }
            
            async function handleAdminLogin() {
                if (adminPasskey.value === ADMIN_PASSKEY) {
                    isAdminAuthenticated = true;
                    adminLogin.classList.add('d-none');
                    adminPanel.classList.remove('d-none');
                    loginError.classList.add('d-none');
                    
                    // Update UI to show admin actions
                    updateUI();
                    updateAdminGroups();
                    
                    // Enable all admin controls
                    document.querySelectorAll('[data-admin-only]').forEach(el => {
                        el.disabled = false;
                    });
                } else {
                    loginError.classList.remove('d-none');
                    isAdminAuthenticated = false;
                }
            }
            
            async function handleJoinGroup(e) {
                e.preventDefault();
                
                const name = studentNameInput.value.trim();
                const id = studentIdInput.value.trim();
                const groupId = parseInt(document.getElementById('studentGroup').value);
                
                if (!name || !id || isNaN(groupId)) {
                    alert('Please fill in all fields and select a group');
                    return;
                }
                
                // Check if student already exists
                const existingStudent = students.find(s => s.id === id);
                if (existingStudent) {
                    alert(`Student with ID ${id} is already assigned to Group ${existingStudent.group + 1}`);
                    return;
                }

                // Check total student count
                if (students.length >= 50) {
                    alert('Maximum student limit (50) reached!');
                    return;
                }
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                // Check if selected group is full
                if (groups[groupId].length >= studentsPerGroup) {
                    alert(`Group ${groupId + 1} is full! Maximum ${studentsPerGroup} students per group.`);
                    return;
                }
                
                // Add to group
                groups[groupId].push({ name, id });
                students.push({ name, id, group: groupId });
                
                await saveData();
                updateUI();
                
                // Show success message
                alert(`Successfully joined Group ${groupId + 1}!`);
                
                // Reset form
                e.target.reset();
            }
            
            async function handleLockGroups() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                // Calculate proper group sizes
                let totalGroups, studentsPerGroup;
                if (groupCountSelect.value === 'custom') {
                    totalGroups = parseInt(customGroupCount.value);
                    if (totalGroups < 2 || totalGroups > 25) {
                        alert('Custom group count must be between 2 and 25');
                        return;
                    }
                    studentsPerGroup = Math.floor(50 / totalGroups);
                    if (studentsPerGroup < 2) {
                        alert('Too many groups! Each group must have at least 2 students');
                        return;
                    }
                    groupSize = totalGroups;
                    groupCount = 'custom';
                } else {
                    totalGroups = parseInt(groupCountSelect.value);
                    studentsPerGroup = totalGroups === 5 ? 10 : 5;
                    groupCount = totalGroups;
                    groupSize = studentsPerGroup;
                }
                
                isLocked = true;
                
                // Initialize groups array
                groups = Array(totalGroups).fill().map(() => []);
                
                // Assign existing students
                students.forEach(student => {
                    if (student.group !== null && student.group < totalGroups) {
                        // Check if group is not full
                        if (groups[student.group].length < studentsPerGroup) {
                        groups[student.group].push({ name: student.name, id: student.id });
                        } else {
                            // Find a group with space
                            const availableGroups = groups
                                .map((group, idx) => ({ idx, size: group.length }))
                                .filter(g => g.size < studentsPerGroup)
                                .map(g => g.idx);
                            
                            if (availableGroups.length > 0) {
                                const randomGroup = availableGroups[Math.floor(Math.random() * availableGroups.length)];
                                groups[randomGroup].push({ name: student.name, id: student.id });
                                student.group = randomGroup;
                            } else {
                                student.group = null; // No available groups
                            }
                        }
                    } else if (student.group === null) {
                        // Assign pending students to groups with space
                        const availableGroups = groups
                            .map((group, idx) => ({ idx, size: group.length }))
                            .filter(g => g.size < studentsPerGroup)
                            .map(g => g.idx);
                        
                        if (availableGroups.length > 0) {
                        const randomGroup = availableGroups[Math.floor(Math.random() * availableGroups.length)];
                        groups[randomGroup].push({ name: student.name, id: student.id });
                        student.group = randomGroup;
                        }
                    }
                });
                
                adminStatus.innerHTML = `<i class="bi bi-check-circle-fill"></i> Groups locked! ${totalGroups} groups with ${studentsPerGroup} students each.`;
                adminStatus.className = 'alert alert-success mt-3';
                
                await saveData();
                updateUI();
            }
            
            function handleGroupCountChange() {
                if (groupCountSelect.value === 'custom') {
                    customGroupContainer.classList.remove('d-none');
                } else {
                    customGroupContainer.classList.add('d-none');
                    groupCount = parseInt(groupCountSelect.value);
                    saveData();
                }
            }
            
            function updateCustomGroupCount() {
                groupSize = parseInt(customGroupCount.value);
                saveData();
            }
            
            function updateUI() {
                // Update groups display
                groupsContainer.innerHTML = '';
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                // Update group selection dropdown
                const groupSelect = document.getElementById('studentGroup');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">Choose your group...</option>';
                    for (let i = 0; i < totalGroups; i++) {
                        const group = groups[i] || [];
                        const isFull = group.length >= studentsPerGroup;
                        
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Group ${i + 1} (${group.length}/${studentsPerGroup} members)`;
                        option.disabled = isFull;
                        if (isFull) {
                            option.textContent += ' - Full';
                        }
                        groupSelect.appendChild(option);
                    }
                }
                
                // Update groups display
                for (let i = 0; i < totalGroups; i++) {
                    const group = groups[i] || [];
                    const groupElement = document.createElement('div');
                    groupElement.className = 'col-md-6 col-lg-4 mb-4';
                    groupElement.innerHTML = `
                        <div class="card group-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Group ${i + 1}</h5>
                                <span class="badge ${group.length >= studentsPerGroup ? 'badge-full' : 'badge-count'}">
                                    ${group.length}/${studentsPerGroup}
                                </span>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                    ${group.map(member => `
                                        <li class="student-item">
                                            <strong>${member.name}</strong>
                                            <small class="text-muted d-block">${member.id}</small>
                                        </li>
                                    `).join('')}
                                    ${group.length === 0 ? '<li class="student-item text-muted">No members yet</li>' : ''}
                                </ul>
                            </div>
                        </div>
                    `;
                    groupsContainer.appendChild(groupElement);
                }
                
                // Update admin status with current counts
                const totalStudents = students.length;
                const maxStudents = 50;
                
                if (isLocked) {
                    adminStatus.innerHTML = `
                        <i class="bi bi-lock-fill"></i> Groups are locked (${totalGroups} groups, ${studentsPerGroup} students each)<br>
                        <small>Total Students: ${totalStudents}/${maxStudents}</small>
                    `;
                    adminStatus.className = 'alert alert-success mt-3';
                    lockGroupsBtn.disabled = true;
                } else {
                    adminStatus.innerHTML = `
                        <i class="bi bi-unlock-fill"></i> Groups are not locked yet (${totalGroups} groups configured)<br>
                        <small>Total Students: ${totalStudents}/${maxStudents}</small>
                    `;
                    adminStatus.className = 'alert alert-warning mt-3';
                    lockGroupsBtn.disabled = false;
                }
                
                // Update student registry
                studentRegistry.innerHTML = '';
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.id}</td>
                        <td>${student.group !== null ? `Group ${student.group + 1}` : 'Pending'}</td>
                        <td>
                            ${isAdminAuthenticated ? `
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-student" data-id="${student.id}">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                            <button class="btn btn-sm btn-outline-danger remove-student" data-id="${student.id}">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                            </div>
                            ` : ''}
                        </td>
                    `;
                    studentRegistry.appendChild(row);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-student').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                            alert('Admin authentication required');
                            return;
                        }
                        
                        const studentId = this.getAttribute('data-id');
                        if (confirm(`Remove student ${studentId}?`)) {
                            // Remove from students array
                            students = students.filter(s => s.id !== studentId);
                            
                            // Remove from groups
                            groups = groups.map(group => 
                                group.filter(member => member.id !== studentId)
                            );
                            
                            await saveData();
                            updateUI();
                        }
                    });
                });
                
                // Set group count selector
                if (groupCount === 'custom') {
                    groupCountSelect.value = 'custom';
                    customGroupContainer.classList.remove('d-none');
                    customGroupCount.value = groupSize;
                } else {
                    groupCountSelect.value = groupCount;
                    customGroupContainer.classList.add('d-none');
                }
            }
            
            async function resetApplication() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
                    groups = initialData.groups;
                    students = initialData.students;
                    isLocked = initialData.isLocked;
                    groupCount = initialData.groupCount;
                    groupSize = initialData.groupSize;
                    
                    await saveData();
                    updateUI();
                    alert('All data has been reset!');
                }
            }

            async function handleUnlockGroups() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                if (confirm('Are you sure you want to unlock the groups? This will allow students to be reassigned.')) {
                    isLocked = false;
                    await saveData();
                    updateUI();
                    adminStatus.innerHTML = `<i class="bi bi-unlock-fill"></i> Groups have been unlocked. Students can now be reassigned.`;
                    adminStatus.className = 'alert alert-warning mt-3';
                }
            }

            async function editStudent(studentId) {
                const student = students.find(s => s.id === studentId);
                if (!student) return;

                const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                document.getElementById('editStudentId').value = student.id;
                document.getElementById('editStudentName').value = student.name;
                
                const groupSelect = document.getElementById('editStudentGroup');
                groupSelect.innerHTML = '<option value="">Select Group</option>';
                
                const totalGroups = groupCount === 'custom' ? groupSize : groupCount;
                for (let i = 0; i < totalGroups; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Group ${i + 1}`;
                    if (student.group === i) option.selected = true;
                    groupSelect.appendChild(option);
                }
                
                modal.show();
            }

            async function saveStudentEdit() {
                const studentId = document.getElementById('editStudentId').value;
                const newName = document.getElementById('editStudentName').value.trim();
                const newGroup = parseInt(document.getElementById('editStudentGroup').value);
                
                if (!newName) {
                    alert('Please enter a valid name');
                    return;
                }
                
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex === -1) return;
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                // Check if target group is full
                if (!isNaN(newGroup) && groups[newGroup].length >= studentsPerGroup) {
                    alert(`Group ${newGroup + 1} is full! Maximum ${studentsPerGroup} students per group.`);
                    return;
                }
                
                // Remove from old group
                if (students[studentIndex].group !== null) {
                    groups[students[studentIndex].group] = groups[students[studentIndex].group]
                        .filter(member => member.id !== studentId);
                }
                
                // Add to new group
                if (!isNaN(newGroup)) {
                    groups[newGroup].push({ name: newName, id: studentId });
                    students[studentIndex].group = newGroup;
                } else {
                    students[studentIndex].group = null;
                }
                
                students[studentIndex].name = newName;
                
                await saveData();
                updateUI();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                modal.hide();
            }

            // Add event listeners for new buttons
            document.querySelectorAll('.edit-student').forEach(btn => {
                btn.addEventListener('click', () => editStudent(btn.getAttribute('data-id')));
            });

            // Add event listener for unlock groups button
            document.getElementById('unlockGroups').addEventListener('click', handleUnlockGroups);

            // Add this to the JavaScript section, inside the DOMContentLoaded event listener
            function updateAdminGroups() {
                const adminGroupsContainer = document.getElementById('adminGroupsContainer');
                if (!adminGroupsContainer) return;
                
                adminGroupsContainer.innerHTML = '';
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                for (let i = 0; i < totalGroups; i++) {
                    const group = groups[i] || [];
                    const groupElement = document.createElement('div');
                    groupElement.className = 'col-md-6 mb-4';
                    groupElement.innerHTML = `
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <div class="group-header">
                                    <div class="group-name-edit">
                                        <input type="text" class="group-name-input" 
                                               value="Group ${i + 1}" 
                                               data-group-id="${i}"
                                               ${!isAdminAuthenticated ? 'disabled' : ''}>
                                        <button class="btn btn-sm btn-light edit-group-name" 
                                                data-group-id="${i}"
                                                data-admin-only="true"
                                                ${!isAdminAuthenticated ? 'disabled' : ''}>
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                    </div>
                                    <span class="badge ${group.length >= studentsPerGroup ? 'badge-full' : 'badge-count'}">
                                        ${group.length}/${studentsPerGroup}
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="add-member-form">
                                    <button class="btn btn-primary btn-sm add-member-btn" 
                                            data-group-id="${i}"
                                            data-admin-only="true"
                                            ${!isAdminAuthenticated || group.length >= studentsPerGroup ? 'disabled' : ''}>
                                        <i class="bi bi-person-plus-fill"></i> Add Member
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>ID</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${group.map(member => `
                                                <tr>
                                                    <td>${member.name}</td>
                                                    <td>${member.id}</td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-primary edit-member" 
                                                                    data-id="${member.id}"
                                                                    data-admin-only="true"
                                                                    ${!isAdminAuthenticated ? 'disabled' : ''}>
                                                                <i class="bi bi-pencil-fill"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger remove-member" 
                                                                    data-id="${member.id}"
                                                                    data-admin-only="true"
                                                                    ${!isAdminAuthenticated ? 'disabled' : ''}>
                                                                <i class="bi bi-trash-fill"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                            ${group.length === 0 ? `
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted">No members yet</td>
                                                </tr>
                                            ` : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    adminGroupsContainer.appendChild(groupElement);
                }
                
                // Add event listeners for admin actions
                if (isAdminAuthenticated) {
                    // Group name editing
                    document.querySelectorAll('.edit-group-name').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (!isAdminAuthenticated) return;
                            const groupId = this.getAttribute('data-group-id');
                            const input = document.querySelector(`.group-name-input[data-group-id="${groupId}"]`);
                            input.disabled = false;
                            input.focus();
                        });
                    });
                    
                    document.querySelectorAll('.group-name-input').forEach(input => {
                        input.addEventListener('blur', async function() {
                            if (!isAdminAuthenticated) return;
                            const groupId = this.getAttribute('data-group-id');
                            const newName = this.value.trim();
                            if (newName) {
                                this.value = newName;
                                this.disabled = true;
                                await saveData();
                            }
                        });
                        
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                this.blur();
                            }
                        });
                    });
                    
                    // Add member
                    document.querySelectorAll('.add-member-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (!isAdminAuthenticated) return;
                            const groupId = parseInt(this.getAttribute('data-group-id'));
                            document.getElementById('addMemberGroupId').value = groupId;
                            const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
                            modal.show();
                        });
                    });
                    
                    // Remove member
                    document.querySelectorAll('.remove-member').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            if (!isAdminAuthenticated) return;
                            const memberId = this.getAttribute('data-id');
                            if (confirm('Remove this member from the group?')) {
                                // Remove from students array
                                students = students.filter(s => s.id !== memberId);
                                
                                // Remove from groups
                                groups = groups.map(group => 
                                    group.filter(member => member.id !== memberId)
                                );
                                
                                await saveData();
                                updateUI();
                            }
                        });
                    });
                    
                    // Edit member
                    document.querySelectorAll('.edit-member').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (!isAdminAuthenticated) return;
                            const memberId = this.getAttribute('data-id');
                            openEditMemberModal(memberId);
                        });
                    });
                }
            }

            // Add this to handle new member addition
            document.getElementById('saveNewMember').addEventListener('click', async function() {
                const groupId = parseInt(document.getElementById('addMemberGroupId').value);
                const name = document.getElementById('newMemberName').value.trim();
                const id = document.getElementById('newMemberId').value.trim();
                
                if (!name || !id) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Check if student already exists
                if (students.some(s => s.id === id)) {
                    alert('A student with this ID already exists');
                    return;
                }
                
                // Add to group and students array
                groups[groupId].push({ name, id });
                students.push({ name, id, group: groupId });
                
                await saveData();
                updateUI();
                updateAdminGroups();
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal'));
                modal.hide();
                document.getElementById('addMemberForm').reset();
            });

            // Update the updateUI function to properly handle admin state
            const originalUpdateUI = updateUI;
            updateUI = function() {
                originalUpdateUI();
                
                // Update admin controls visibility
                document.querySelectorAll('[data-admin-only]').forEach(el => {
                    el.disabled = !isAdminAuthenticated;
                });
                
                if (isAdminAuthenticated) {
                    updateAdminGroups();
                }
            };

            // Add this to handle admin logout
            function handleAdminLogout() {
                isAdminAuthenticated = false;
                adminLogin.classList.remove('d-none');
                adminPanel.classList.add('d-none');
                document.getElementById('adminPasskey').value = '';
                updateUI();
            }

            // Add logout button to admin panel
            document.querySelector('.admin-panel').insertAdjacentHTML('afterbegin', `
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-outline-danger btn-sm" onclick="handleAdminLogout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            `);

            // Add this to handle new member management features
            function updateAdminMemberList(searchTerm = '') {
                const memberList = document.getElementById('adminMemberList');
                if (!memberList) return;
                
                const filteredMembers = students.filter(student => 
                    !searchTerm || 
                    student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    student.id.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                memberList.innerHTML = filteredMembers.map(student => `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.id}</td>
                        <td>${student.group !== null ? `Group ${student.group + 1}` : 'Not Assigned'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditMemberModal('${student.id}')">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeMember('${student.id}')">
                                <i class="bi bi-trash-fill"></i> Remove
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="text-center">No members found</td></tr>';
            }

            function updateGroupSelects() {
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const groupSelects = ['newMemberGroup', 'editMemberGroup'];
                
                groupSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    select.innerHTML = '<option value="">Select a group...</option>';
                    for (let i = 0; i < totalGroups; i++) {
                        const group = groups[i] || [];
                        const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                        const isFull = group.length >= studentsPerGroup;
                        
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Group ${i + 1} (${group.length}/${studentsPerGroup} members)`;
                        option.disabled = isFull;
                        if (isFull) {
                            option.textContent += ' - Full';
                        }
                        select.appendChild(option);
                    }
                });
            }

            async function openEditMemberModal(memberId) {
                const student = students.find(s => s.id === memberId);
                if (!student) return;
                
                document.getElementById('editMemberId').value = student.id;
                document.getElementById('editMemberName').value = student.name;
                
                const groupSelect = document.getElementById('editMemberGroup');
                updateGroupSelects();
                groupSelect.value = student.group !== null ? student.group : '';
                
                const modal = new bootstrap.Modal(document.getElementById('editMemberModal'));
                modal.show();
            }

            async function removeMember(memberId) {
                // Remove from students array
                students = students.filter(s => s.id !== memberId);
                
                // Remove from groups
                groups = groups.map(group => 
                    group.filter(member => member.id !== memberId)
                );
                
                await saveData();
                updateUI();
                updateAdminMemberList(document.getElementById('memberSearch').value);
            }

            // Add event listeners for the new member management features
            document.getElementById('directAddMemberForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('newMemberName').value.trim();
                const id = document.getElementById('newMemberId').value.trim();
                const groupId = parseInt(document.getElementById('newMemberGroup').value);
                
                if (!name || !id || isNaN(groupId)) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Check if student already exists
                if (students.some(s => s.id === id)) {
                    alert('A student with this ID already exists');
                    return;
                }
                
                // Add to group and students array
                groups[groupId].push({ name, id });
                students.push({ name, id, group: groupId });
                
                await saveData();
                updateUI();
                updateAdminMemberList();
                this.reset();
            });

            document.getElementById('saveMemberEdit').addEventListener('click', async function() {
                const memberId = document.getElementById('editMemberId').value;
                const newName = document.getElementById('editMemberName').value.trim();
                const newGroup = parseInt(document.getElementById('editMemberGroup').value);
                
                if (!newName || isNaN(newGroup)) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const studentIndex = students.findIndex(s => s.id === memberId);
                if (studentIndex === -1) return;
                
                // Remove from old group
                if (students[studentIndex].group !== null) {
                    groups[students[studentIndex].group] = groups[students[studentIndex].group]
                        .filter(member => member.id !== memberId);
                }
                
                // Add to new group
                groups[newGroup].push({ name: newName, id: memberId });
                students[studentIndex].name = newName;
                students[studentIndex].group = newGroup;
                
                await saveData();
                updateUI();
                updateAdminMemberList(document.getElementById('memberSearch').value);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editMemberModal'));
                modal.hide();
            });

            document.getElementById('memberSearch').addEventListener('input', function() {
                updateAdminMemberList(this.value);
            });

            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('memberSearch').value = '';
                updateAdminMemberList();
            });
        });
    </script>
</body>
</html>