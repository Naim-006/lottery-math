<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Group Lottery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .nav-tabs .nav-link {
            font-weight: 500;
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        .group-card {
            border: none;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            margin-bottom: 1.5rem;
            height: 100%;
        }
        
        .group-card:hover {
            transform: translateY(-5px);
        }
        
        .group-card .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
        }
        
        .student-item {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .student-item:last-child {
            border-bottom: none;
        }
        
        .badge-count {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-full {
            background-color: var(--danger-color);
            color: white;
        }
        
        #resultAnimation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: white;
        }
        
        .lottery-wheel {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 2rem auto;
        }
        
        .wheel-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: spin 3s cubic-bezier(0.17, 0.67, 0.83, 0.67) infinite;
        }
        
        .wheel-segment {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid var(--primary-color);
            clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            opacity: 0.8;
            transform-origin: center;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: var(--success-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            box-shadow: 0 0 20px var(--success-color);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid var(--danger-color);
            z-index: 3;
        }
        
        .result-number {
            font-size: 4rem;
            font-weight: bold;
            color: var(--success-color);
            text-shadow: 0 0 20px var(--success-color);
            margin: 1rem 0;
            opacity: 0;
            transform: scale(0.5);
            animation: popIn 0.5s ease-out forwards;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--success-color);
            opacity: 0;
            z-index: 1001;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .admin-panel {
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(67, 97, 238, 0.1);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><i class="bi bi-people-fill"></i> Class Group Lottery</h1>
            <p class="text-muted">Randomly assign students to groups with persistent storage</p>
        </div>
        
        <ul class="nav nav-tabs" id="appTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">
                    <i class="bi bi-person-fill"></i> Student View
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">
                    <i class="bi bi-gear-fill"></i> Admin Panel
                </button>
            </li>
        </ul>
        
        <div class="tab-content py-4" id="appTabContent">
            <!-- Student View -->
            <div class="tab-pane fade show active" id="student" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="card shadow-sm mb-5">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-shuffle"></i> Draw Your Group</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="studentName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="studentName" placeholder="Enter your full name">
                                </div>
                                <div class="mb-3">
                                    <label for="studentId" class="form-label">Student ID</label>
                                    <input type="text" class="form-control" id="studentId" placeholder="Enter your student ID">
                                </div>
                                <button class="btn btn-primary w-100 py-2" id="drawLottery">
                                    <i class="bi bi-shuffle"></i> Draw My Group
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h4 class="text-center mb-4"><i class="bi bi-collection-fill"></i> Current Groups</h4>
                <div class="row" id="groupsContainer">
                    <!-- Groups will be loaded here -->
                </div>
            </div>
            
            <!-- Admin View -->
            <div class="tab-pane fade" id="admin" role="tabpanel">
                <div id="adminLogin" class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-shield-lock-fill"></i> Admin Authentication</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="adminPasskey" class="form-label">Admin Passkey</label>
                            <input type="password" class="form-control" id="adminPasskey" placeholder="Enter admin passkey">
                        </div>
                        <button class="btn btn-primary w-100" id="loginBtn">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </button>
                        <div class="alert alert-danger mt-3 d-none" id="loginError">
                            Invalid passkey. Please try again.
                        </div>
                    </div>
                </div>
                
                <div id="adminPanel" class="d-none">
                    <div class="admin-panel">
                        <h5 class="mb-3"><i class="bi bi-sliders"></i> Group Configuration</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="groupCount" class="form-label">Number of Groups</label>
                                <select class="form-select" id="groupCount" ${isLocked ? '' : 'disabled'}>
                                    <option value="5">5 Groups (10 students each)</option>
                                    <option value="10">10 Groups (5 students each)</option>
                                    <option value="custom">Custom Setup</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 d-none" id="customGroupContainer">
                                <label for="customGroupCount" class="form-label">Custom Number of Groups</label>
                                <input type="number" class="form-control" id="customGroupCount" min="2" max="20" value="5" ${isLocked ? '' : 'disabled'}>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" id="lockGroups">
                                    <i class="bi bi-lock-fill"></i> ${isLocked ? 'Unlock Groups' : 'Lock Groups'}
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" id="unlockGroups" ${!isLocked ? 'disabled' : ''}>
                                    <i class="bi bi-unlock-fill"></i> Unlock Groups
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" id="resetBtn">
                                    <i class="bi bi-trash-fill"></i> Reset All Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3" id="adminStatus">
                            <i class="bi bi-info-circle-fill"></i> Loading group status...
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="bi bi-list-check"></i> Student Registry</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>ID</th>
                                        <th>Group</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentRegistry">
                                    <!-- Students will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Edit Student Modal -->
                    <div class="modal fade" id="editStudentModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Student</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editStudentForm">
                                        <input type="hidden" id="editStudentId">
                                        <div class="mb-3">
                                            <label for="editStudentName" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="editStudentName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editStudentGroup" class="form-label">Group</label>
                                            <select class="form-select" id="editStudentGroup">
                                                <option value="">Select Group</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="saveStudentEdit">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Result Animation -->
    <div id="resultAnimation" class="d-none">
        <div class="lottery-wheel">
            <div class="wheel-pointer"></div>
            <div class="wheel-container" id="wheelContainer">
                <!-- Wheel segments will be added dynamically -->
            </div>
            <div class="wheel-center"></div>
        </div>
        <div class="result-number" id="resultNumber"></div>
        <h3 id="resultText" class="text-center">Drawing your group...</h3>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main App Script -->
    <script>
        // JSONBin.io Configuration
        // To get these credentials:
        // 1. Sign up at https://jsonbin.io/
        // 2. Create a new bin (or use an existing one)
        // 3. Get your Master Key from your dashboard
        // 4. Get your Bin ID from the URL of your bin (https://jsonbin.io/b/YOUR_BIN_ID)
        const BIN_ID = '684d5dd38960c979a5a9c03e'; // Your Bin ID
        const API_KEY = '$2a$10$aakmKGvTIuJG/JpmOAAETOcqb3FEPYjeCeiQFQe/Zjj1o4Bq6O6V6'; // Your Master Key
        const ADMIN_PASSKEY = 'securePass123'; // Change this to your desired admin password
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const studentView = document.getElementById('student');
            const adminView = document.getElementById('admin');
            const adminLogin = document.getElementById('adminLogin');
            const adminPanel = document.getElementById('adminPanel');
            const loginBtn = document.getElementById('loginBtn');
            const adminPasskey = document.getElementById('adminPasskey');
            const loginError = document.getElementById('loginError');
            
            const drawLotteryBtn = document.getElementById('drawLottery');
            const studentNameInput = document.getElementById('studentName');
            const studentIdInput = document.getElementById('studentId');
            const groupsContainer = document.getElementById('groupsContainer');
            const resultAnimation = document.getElementById('resultAnimation');
            const resultText = document.getElementById('resultText');
            
            const lockGroupsBtn = document.getElementById('lockGroups');
            const groupCountSelect = document.getElementById('groupCount');
            const customGroupContainer = document.getElementById('customGroupContainer');
            const customGroupCount = document.getElementById('customGroupCount');
            const adminStatus = document.getElementById('adminStatus');
            const studentRegistry = document.getElementById('studentRegistry');
            const resetBtn = document.getElementById('resetBtn');
            
            // App State
            let groups = [];
            let students = [];
            let isLocked = false;
            let groupCount = 5;
            let groupSize = 10;
            let isAdminAuthenticated = false;
            
            // Initialize the app
            init();
            
            // Event Listeners
            loginBtn.addEventListener('click', handleAdminLogin);
            drawLotteryBtn.addEventListener('click', handleLotteryDraw);
            lockGroupsBtn.addEventListener('click', handleLockGroups);
            groupCountSelect.addEventListener('change', handleGroupCountChange);
            customGroupCount.addEventListener('change', updateCustomGroupCount);
            resetBtn.addEventListener('click', resetApplication);
            
            // Initialize with default data structure
            const initialData = {
                groups: Array(10).fill().map(() => []),
                students: [],
                isLocked: false,
                groupCount: 5,
                groupSize: 10,
                createdAt: new Date().toISOString()
            };
            
            // Main Functions
            async function init() {
                try {
                    const data = await fetchData();
                    
                    if (data) {
                        groups = data.groups || initialData.groups;
                        students = data.students || initialData.students;
                        isLocked = data.isLocked || initialData.isLocked;
                        groupCount = data.groupCount || initialData.groupCount;
                        groupSize = data.groupSize || initialData.groupSize;
                        
                        updateUI();
                    } else {
                        // If no data found, create initial bin
                        await createBin();
                        groups = initialData.groups;
                        students = initialData.students;
                        isLocked = initialData.isLocked;
                        groupCount = initialData.groupCount;
                        groupSize = initialData.groupSize;
                    }
                } catch (error) {
                    console.error('Initialization error:', error);
                    alert('Failed to initialize application. Please try again later.');
                }
            }
            
            async function fetchData() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: {
                            'X-Master-Key': API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            return null; // Bin doesn't exist
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    console.error('Fetch error:', error);
                    return null;
                }
            }
            
            async function createBin() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY,
                            'X-Bin-Name': 'Class Group Lottery Data'
                        },
                        body: JSON.stringify(initialData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to create bin');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Bin creation error:', error);
                    return null;
                }
            }
            
            async function saveData() {
                const data = {
                    groups,
                    students,
                    isLocked,
                    groupCount,
                    groupSize,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to save data');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Save error:', error);
                    // Fallback to localStorage
                    localStorage.setItem('lotteryData', JSON.stringify(data));
                    return null;
                }
            }
            
            async function handleAdminLogin() {
                if (adminPasskey.value === ADMIN_PASSKEY) {
                    isAdminAuthenticated = true;
                    adminLogin.classList.add('d-none');
                    adminPanel.classList.remove('d-none');
                    loginError.classList.add('d-none');
                } else {
                    loginError.classList.remove('d-none');
                }
            }
            
            async function handleLotteryDraw() {
                const name = studentNameInput.value.trim();
                const id = studentIdInput.value.trim();
                
                if (!name || !id) {
                    alert('Please enter both your name and student ID');
                    return;
                }
                
                // Check if student already exists
                const existingStudent = students.find(s => s.id === id);
                if (existingStudent) {
                    if (existingStudent.group !== null) {
                        showResult(`You're in Group ${existingStudent.group + 1}`, false);
                    } else {
                        showResult('Assignment pending. Groups not locked yet.', false);
                    }
                    return;
                }

                // Check total student count
                if (students.length >= 50) {
                    showResult('Maximum student limit (50) reached!', false);
                    return;
                }
                
                if (isLocked) {
                    // Calculate group capacity based on current setup
                    const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                    const studentsPerGroup = Math.floor(50 / totalGroups);
                    
                    // Check if all groups are full
                    const activeGroups = groups.slice(0, totalGroups);
                    const totalAssigned = activeGroups.reduce((sum, group) => sum + group.length, 0);
                    
                    if (totalAssigned >= 50) {
                        showResult('All groups are full! Maximum capacity reached.', false);
                        return;
                    }
                    
                    // Find group with fewest members
                    const groupSizes = activeGroups.map(group => group.length);
                    const minSize = Math.min(...groupSizes);
                    const availableGroups = activeGroups
                        .map((group, idx) => ({ idx, size: group.length }))
                        .filter(g => g.size === minSize && g.size < studentsPerGroup)
                        .map(g => g.idx);
                    
                    if (availableGroups.length === 0) {
                        showResult('No available groups with space!', false);
                        return;
                    }
                    
                    const randomGroup = availableGroups[Math.floor(Math.random() * availableGroups.length)];
                    
                    // Add to group
                    groups[randomGroup].push({ name, id });
                    students.push({ name, id, group: randomGroup });
                    
                    // Show result with animation
                    await showResult(`You're in Group ${randomGroup + 1}!`, true);
                } else {
                    // Just show a preview
                    const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                    const randomGroup = Math.floor(Math.random() * totalGroups);
                    students.push({ name, id, group: null });
                    // Show preview with animation
                    await showResult(`Preview: Group ${randomGroup + 1} (not locked)`, true);
                }
                
                await saveData();
                updateUI();
            }
            
            async function handleLockGroups() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                // Calculate proper group sizes
                let totalGroups, studentsPerGroup;
                if (groupCountSelect.value === 'custom') {
                    totalGroups = parseInt(customGroupCount.value);
                    if (totalGroups < 2 || totalGroups > 25) {
                        alert('Custom group count must be between 2 and 25');
                        return;
                    }
                    studentsPerGroup = Math.floor(50 / totalGroups);
                    if (studentsPerGroup < 2) {
                        alert('Too many groups! Each group must have at least 2 students');
                        return;
                    }
                    groupSize = totalGroups;
                    groupCount = 'custom';
                } else {
                    totalGroups = parseInt(groupCountSelect.value);
                    studentsPerGroup = totalGroups === 5 ? 10 : 5;
                    groupCount = totalGroups;
                    groupSize = studentsPerGroup;
                }
                
                isLocked = true;
                
                // Initialize groups array
                groups = Array(totalGroups).fill().map(() => []);
                
                // Assign existing students
                students.forEach(student => {
                    if (student.group !== null && student.group < totalGroups) {
                        // Check if group is not full
                        if (groups[student.group].length < studentsPerGroup) {
                            groups[student.group].push({ name: student.name, id: student.id });
                        } else {
                            // Find a group with space
                            const availableGroups = groups
                                .map((group, idx) => ({ idx, size: group.length }))
                                .filter(g => g.size < studentsPerGroup)
                                .map(g => g.idx);
                            
                            if (availableGroups.length > 0) {
                                const randomGroup = availableGroups[Math.floor(Math.random() * availableGroups.length)];
                                groups[randomGroup].push({ name: student.name, id: student.id });
                                student.group = randomGroup;
                            } else {
                                student.group = null; // No available groups
                            }
                        }
                    } else if (student.group === null) {
                        // Assign pending students to groups with space
                        const availableGroups = groups
                            .map((group, idx) => ({ idx, size: group.length }))
                            .filter(g => g.size < studentsPerGroup)
                            .map(g => g.idx);
                        
                        if (availableGroups.length > 0) {
                            const randomGroup = availableGroups[Math.floor(Math.random() * availableGroups.length)];
                            groups[randomGroup].push({ name: student.name, id: student.id });
                            student.group = randomGroup;
                        }
                    }
                });
                
                adminStatus.innerHTML = `<i class="bi bi-check-circle-fill"></i> Groups locked! ${totalGroups} groups with ${studentsPerGroup} students each.`;
                adminStatus.className = 'alert alert-success mt-3';
                
                await saveData();
                updateUI();
            }
            
            function handleGroupCountChange() {
                if (groupCountSelect.value === 'custom') {
                    customGroupContainer.classList.remove('d-none');
                } else {
                    customGroupContainer.classList.add('d-none');
                    groupCount = parseInt(groupCountSelect.value);
                    saveData();
                }
            }
            
            function updateCustomGroupCount() {
                groupSize = parseInt(customGroupCount.value);
                saveData();
            }
            
            function createWheelSegments(totalGroups) {
                const container = document.getElementById('wheelContainer');
                container.innerHTML = '';
                
                for (let i = 0; i < totalGroups; i++) {
                    const segment = document.createElement('div');
                    segment.className = 'wheel-segment';
                    segment.style.transform = `rotate(${(360 / totalGroups) * i}deg)`;
                    container.appendChild(segment);
                }
            }

            function createConfetti() {
                const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#7209b7'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(confetti);
                    
                    // Remove confetti after animation
                    setTimeout(() => confetti.remove(), 5000);
                }
            }

            async function showResult(message, isSuccess) {
                const resultAnimation = document.getElementById('resultAnimation');
                const resultText = document.getElementById('resultText');
                const resultNumber = document.getElementById('resultNumber');
                const wheelContainer = document.getElementById('wheelContainer');
                
                resultAnimation.classList.remove('d-none');
                resultText.textContent = 'Drawing your group...';
                resultNumber.textContent = '';
                
                // Create wheel segments based on current group count
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                createWheelSegments(totalGroups);
                
                // Start wheel animation
                wheelContainer.style.animation = 'spin 3s cubic-bezier(0.17, 0.67, 0.83, 0.67) infinite';
                
                // Simulate drawing process
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Stop wheel animation
                wheelContainer.style.animation = 'none';
                
                // Extract group number from message
                const groupMatch = message.match(/Group (\d+)/);
                if (groupMatch) {
                    const groupNumber = groupMatch[1];
                    resultNumber.textContent = groupNumber;
                    
                    if (isSuccess) {
                        createConfetti();
                    }
                }
                
                resultText.textContent = message;
                resultText.className = isSuccess ? 'text-success' : 'text-warning';
                
                // Clean up after animation
                setTimeout(() => {
                    resultAnimation.classList.add('d-none');
                    wheelContainer.style.animation = '';
                    studentNameInput.value = '';
                    studentIdInput.value = '';
                    studentNameInput.focus();
                    
                    // Remove any remaining confetti
                    document.querySelectorAll('.confetti').forEach(c => c.remove());
                }, 3000);
            }
            
            function updateUI() {
                // Update groups display
                groupsContainer.innerHTML = '';
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                for (let i = 0; i < totalGroups; i++) {
                    const group = groups[i] || [];
                    const groupElement = document.createElement('div');
                    groupElement.className = 'col-md-6 col-lg-4 mb-4';
                    groupElement.innerHTML = `
                        <div class="card group-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Group ${i + 1}</h5>
                                <span class="badge ${group.length >= studentsPerGroup ? 'badge-full' : 'badge-count'}">
                                    ${group.length}/${studentsPerGroup}
                                </span>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                    ${group.map(member => `
                                        <li class="student-item">
                                            <strong>${member.name}</strong>
                                            <small class="text-muted d-block">${member.id}</small>
                                        </li>
                                    `).join('')}
                                    ${group.length === 0 ? '<li class="student-item text-muted">No members yet</li>' : ''}
                                </ul>
                            </div>
                        </div>
                    `;
                    groupsContainer.appendChild(groupElement);
                }
                
                // Update admin status with current counts
                const totalStudents = students.length;
                const maxStudents = 50;
                
                if (isLocked) {
                    adminStatus.innerHTML = `
                        <i class="bi bi-lock-fill"></i> Groups are locked (${totalGroups} groups, ${studentsPerGroup} students each)<br>
                        <small>Total Students: ${totalStudents}/${maxStudents}</small>
                    `;
                    adminStatus.className = 'alert alert-success mt-3';
                    lockGroupsBtn.disabled = true;
                } else {
                    adminStatus.innerHTML = `
                        <i class="bi bi-unlock-fill"></i> Groups are not locked yet (${totalGroups} groups configured)<br>
                        <small>Total Students: ${totalStudents}/${maxStudents}</small>
                    `;
                    adminStatus.className = 'alert alert-warning mt-3';
                    lockGroupsBtn.disabled = false;
                }
                
                // Update student registry
                studentRegistry.innerHTML = '';
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.name}</td>
                        <td>${student.id}</td>
                        <td>${student.group !== null ? `Group ${student.group + 1}` : 'Pending'}</td>
                        <td>
                            ${isAdminAuthenticated ? `
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-student" data-id="${student.id}">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger remove-student" data-id="${student.id}">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                            ` : ''}
                        </td>
                    `;
                    studentRegistry.appendChild(row);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-student').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                            alert('Admin authentication required');
                            return;
                        }
                        
                        const studentId = this.getAttribute('data-id');
                        if (confirm(`Remove student ${studentId}?`)) {
                            // Remove from students array
                            students = students.filter(s => s.id !== studentId);
                            
                            // Remove from groups
                            groups = groups.map(group => 
                                group.filter(member => member.id !== studentId)
                            );
                            
                            await saveData();
                            updateUI();
                        }
                    });
                });
                
                // Set group count selector
                if (groupCount === 'custom') {
                    groupCountSelect.value = 'custom';
                    customGroupContainer.classList.remove('d-none');
                    customGroupCount.value = groupSize;
                } else {
                    groupCountSelect.value = groupCount;
                    customGroupContainer.classList.add('d-none');
                }
            }
            
            async function resetApplication() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
                    groups = initialData.groups;
                    students = initialData.students;
                    isLocked = initialData.isLocked;
                    groupCount = initialData.groupCount;
                    groupSize = initialData.groupSize;
                    
                    await saveData();
                    updateUI();
                    alert('All data has been reset!');
                }
            }

            async function handleUnlockGroups() {
                if (!isAdminAuthenticated || adminPasskey.value !== ADMIN_PASSKEY) {
                    alert('Admin authentication required');
                    return;
                }
                
                if (confirm('Are you sure you want to unlock the groups? This will allow students to be reassigned.')) {
                    isLocked = false;
                    await saveData();
                    updateUI();
                    adminStatus.innerHTML = `<i class="bi bi-unlock-fill"></i> Groups have been unlocked. Students can now be reassigned.`;
                    adminStatus.className = 'alert alert-warning mt-3';
                }
            }

            async function editStudent(studentId) {
                const student = students.find(s => s.id === studentId);
                if (!student) return;

                const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                document.getElementById('editStudentId').value = student.id;
                document.getElementById('editStudentName').value = student.name;
                
                const groupSelect = document.getElementById('editStudentGroup');
                groupSelect.innerHTML = '<option value="">Select Group</option>';
                
                const totalGroups = groupCount === 'custom' ? groupSize : groupCount;
                for (let i = 0; i < totalGroups; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Group ${i + 1}`;
                    if (student.group === i) option.selected = true;
                    groupSelect.appendChild(option);
                }
                
                modal.show();
            }

            async function saveStudentEdit() {
                const studentId = document.getElementById('editStudentId').value;
                const newName = document.getElementById('editStudentName').value.trim();
                const newGroup = parseInt(document.getElementById('editStudentGroup').value);
                
                if (!newName) {
                    alert('Please enter a valid name');
                    return;
                }
                
                const studentIndex = students.findIndex(s => s.id === studentId);
                if (studentIndex === -1) return;
                
                const totalGroups = groupCount === 'custom' ? groupSize : parseInt(groupCount);
                const studentsPerGroup = groupCount === 'custom' ? Math.floor(50 / groupSize) : (groupCount === 5 ? 10 : 5);
                
                // Check if target group is full
                if (!isNaN(newGroup) && groups[newGroup].length >= studentsPerGroup) {
                    alert(`Group ${newGroup + 1} is full! Maximum ${studentsPerGroup} students per group.`);
                    return;
                }
                
                // Remove from old group
                if (students[studentIndex].group !== null) {
                    groups[students[studentIndex].group] = groups[students[studentIndex].group]
                        .filter(member => member.id !== studentId);
                }
                
                // Add to new group
                if (!isNaN(newGroup)) {
                    groups[newGroup].push({ name: newName, id: studentId });
                    students[studentIndex].group = newGroup;
                } else {
                    students[studentIndex].group = null;
                }
                
                students[studentIndex].name = newName;
                
                await saveData();
                updateUI();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                modal.hide();
            }

            // Add event listeners for new buttons
            document.querySelectorAll('.edit-student').forEach(btn => {
                btn.addEventListener('click', () => editStudent(btn.getAttribute('data-id')));
            });

            // Add event listener for unlock groups button
            document.getElementById('unlockGroups').addEventListener('click', handleUnlockGroups);
        });
    </script>
</body>
</html>